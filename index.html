<!-- Inside <script> tag -->
<script>
  const app_id = 1089;
  const api_token = "lKcYGLpmaAMgUkH"; // Your Deriv token
  let ws;
  let tickPrices = [];
  const maxTicks = 100;
  let barrier = null;
  let growthRate = 1;

  const ctx = document.getElementById('macdChart').getContext('2d');
  const macdChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'MACD', data: [], borderColor: '#00ffe0', borderWidth: 2 },
        { label: 'Signal', data: [], borderColor: '#ff0040', borderWidth: 2 },
        { label: 'Histogram', data: [], borderColor: '#ff9900', borderWidth: 2 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#fff' } }
      },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' } }
      }
    }
  });

  function applySettings() {
    const vol = document.getElementById('volatilitySelector').value;
    growthRate = parseFloat(document.getElementById('growthRateSelector').value);
    alert(`‚öôÔ∏è Settings applied:\nIndex: ${vol}\nGrowth Rate: ${growthRate}%`);
    tickPrices = [];
    barrier = null;
    connectToDeriv(vol);
  }

  function connectToDeriv(symbol) {
    if (ws) ws.close();
    ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${app_id}`);
    ws.onopen = () => {
      ws.send(JSON.stringify({ authorize: api_token }));
      ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    };
    ws.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      if (data.tick) {
        const price = parseFloat(data.tick.quote);
        tickPrices.push(price);
        if (tickPrices.length > maxTicks) tickPrices.shift();

        if (!barrier) {
          barrier = price * (1 + growthRate / 100);
          console.log(`üìà Barrier set at ${barrier.toFixed(5)}`);
        }

        checkBarrierRisk(price);
        updateMACDChart();
      }
    };
  }

  function calculateEMA(period, prices) {
    const k = 2 / (period + 1);
    let ema = prices[0];
    const result = [ema];
    for (let i = 1; i < prices.length; i++) {
      ema = prices[i] * k + ema * (1 - k);
      result.push(ema);
    }
    return result;
  }

  function updateMACDChart() {
    if (tickPrices.length < 26) return;
    const ema12 = calculateEMA(12, tickPrices);
    const ema26 = calculateEMA(26, tickPrices);
    const macd = ema12.map((val, i) => val - ema26[i]);
    const signal = calculateEMA(9, macd);
    const histogram = macd.map((val, i) => val - signal[i]);

    macdChart.data.labels = tickPrices.map((_, i) => `T${i}`);
    macdChart.data.datasets[0].data = macd;
    macdChart.data.datasets[1].data = signal;
    macdChart.data.datasets[2].data = histogram;
    macdChart.update();
  }

  function checkBarrierRisk(currentPrice) {
    if (!barrier) return;
    const distance = barrier - currentPrice;
    const threshold = 5;

    if (distance <= threshold && distance > 0) {
      console.warn(`üö® Near barrier! Distance: ${distance.toFixed(5)}`);
      if (document.getElementById('shieldToggle').checked) {
        document.querySelectorAll('button').forEach(btn => {
          if (btn.innerText.includes('Buy') || btn.innerText.includes('Sell')) {
            btn.disabled = true;
            btn.style.opacity = 0.5;
          }
        });
      }
    } else {
      document.querySelectorAll('button').forEach(btn => {
        if (btn.innerText.includes('Buy') || btn.innerText.includes('Sell')) {
          btn.disabled = false;
          btn.style.opacity = 1;
        }
      });
    }
  }

  function manualTrade(type) {
    const shield = document.getElementById('shieldToggle').checked;
    if (shield) {
      alert('üõ°Ô∏è Loss Shield is active. Trade blocked.');
      return;
    }
    alert(`üî• ${type.toUpperCase()} executed manually.`);
  }
</script>
</body>
</html>
