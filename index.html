<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deriv Volatility Dashboard</title>
  <style>
    body { background: #222; color: #fff; font-family: sans-serif; }
    #controls { margin: 20px auto; display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap;}
    #chart { width: 90vw; height: 400px; margin: 0 auto; }
    #alerts { margin: 20px auto; text-align: center; color: #ff4a4a; }
    input, select, button { padding: 6px; border-radius: 6px; border: 1px solid #888; }
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div id="controls">
    <label>Asset:
      <select id="asset">
        <option value="R_10">Volatility 10 Index</option>
        <option value="R_25">Volatility 25 Index</option>
        <option value="R_50">Volatility 50 Index</option>
        <option value="R_75">Volatility 75 Index</option>
        <option value="R_100">Volatility 100 Index</option>
        <option value="R_10_1HZ">Volatility 10 (1s) Index</option>
        <option value="R_25_1HZ">Volatility 25 (1s) Index</option>
        <option value="R_50_1HZ">Volatility 50 (1s) Index</option>
        <option value="R_75_1HZ">Volatility 75 (1s) Index</option>
        <option value="R_100_1HZ">Volatility 100 (1s) Index</option>
        <option value="R_20">Volatility 20 Index</option>
        <option value="R_30">Volatility 30 Index</option>
        <option value="R_60">Volatility 60 Index</option>
        <option value="R_80">Volatility 80 Index</option>
        <option value="R_90">Volatility 90 Index</option>
        <option value="R_20_1HZ">Volatility 20 (1s) Index</option>
        <option value="R_30_1HZ">Volatility 30 (1s) Index</option>
        <option value="R_60_1HZ">Volatility 60 (1s) Index</option>
        <option value="R_80_1HZ">Volatility 80 (1s) Index</option>
        <option value="R_90_1HZ">Volatility 90 (1s) Index</option>
        <option value="R_100_2HZ">Volatility 100 (2s) Index</option>
        <option value="R_50_2HZ">Volatility 50 (2s) Index</option>
        <option value="R_75_2HZ">Volatility 75 (2s) Index</option>
        <option value="R_25_2HZ">Volatility 25 (2s) Index</option>
        <option value="R_10_2HZ">Volatility 10 (2s) Index</option>
        <option value="R_250">Volatility 250 Index</option>
        <option value="R_500">Volatility 500 Index</option>
        <option value="R_1000">Volatility 1000 Index</option>
      </select>
    </label>
    <label>Timeframe:
      <select id="timeframe">
        <option value="1m">1 Min</option>
        <option value="5m">5 Min</option>
        <option value="1h">1 Hour</option>
      </select>
    </label>
    <label>Barrier:
      <input type="number" id="barrier" placeholder="Enter price" step="0.01">
    </label>
    <button type="button" id="zoom-in">Zoom In</button>
    <button type="button" id="zoom-out">Zoom Out</button>
  </div>
  <div id="chart"></div>
  <div id="alerts"></div>
  <script>
    // --- Chart setup
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      width: document.getElementById('chart').offsetWidth,
      height: 400,
      layout: { background: { color: "#222" }, textColor: "#fff" }
    });
    const candleSeries = chart.addCandlestickSeries();

    // --- State
    let ws;
    let asset = document.getElementById('asset').value;
    let timeframe = document.getElementById('timeframe').value;
    let granularity = 60;
    let barrier = null;
    let candles = [];

    function tfToGranularity(tf) {
      if (tf === '1m') return 60;
      if (tf === '5m') return 300;
      if (tf === '1h') return 3600;
      return 60;
    }

    function connect() {
      if (ws) {
        ws.close();
      }
      granularity = tfToGranularity(timeframe);
      candles = []; // Reset candles for new asset/timeframe
      candleSeries.setData([]);
      ws = new WebSocket('wss://ws.deriv.com/websockets/v3?app_id=1089');
      ws.onopen = () => {
        ws.send(JSON.stringify({
          ticks_history: asset,
          count: 100,
          end: 'latest',
          style: 'candles',
          granularity: granularity
        }));
        ws.send(JSON.stringify({
          ticks: asset,
          subscribe: 1
        }));
      };
      ws.onmessage = msg => {
        const data = JSON.parse(msg.data);
        if (data.history && data.history.candles) {
          candles = data.history.candles.map(c => ({
            epoch: c.epoch,
            open: c.open,
            high: c.high,
            low: c.low,
            close: c.close
          }));
          renderCandles();
        }
        if (data.tick) {
          handleTick(data.tick);
        }
      };
      ws.onerror = () => {
        document.getElementById('alerts').innerText = "Error connecting to Deriv WebSocket. Try a different asset or reload.";
      };
    }

    function renderCandles() {
      const formatted = candles.map(c => ({
        time: c.epoch,
        open: c.open,
        high: c.high,
        low: c.low,
        close: c.close
      }));
      candleSeries.setData(formatted);
      runSignals();
    }

    function handleTick(tick) {
      const latest = {
        epoch: tick.epoch,
        open: tick.quote,
        high: tick.quote,
        low: tick.quote,
        close: tick.quote
      };
      if (candles.length && candles[candles.length - 1].epoch === latest.epoch) {
        // Update last candle
        candles[candles.length - 1] = latest;
      } else {
        candles.push(latest);
        if (candles.length > 100) candles.shift();
      }
      candleSeries.update({
        time: latest.epoch,
        open: latest.open,
        high: latest.high,
        low: latest.low,
        close: latest.close
      });
      runSignals();
    }

    function runSignals() {
      const b = parseFloat(barrier);
      if (!b) {
        document.getElementById('alerts').innerHTML = '';
        return;
      }
      let alerts = [];
      // Buy/sell cross
      for (let i = 1; i < candles.length; i++) {
        if (candles[i-1].close < b && candles[i].close > b)
          alerts.push(`BUY at ${candles[i].close} (${new Date(candles[i].epoch*1000).toLocaleTimeString()})`);
        if (candles[i-1].close > b && candles[i].close < b)
          alerts.push(`SELL at ${candles[i].close} (${new Date(candles[i].epoch*1000).toLocaleTimeString()})`);
      }
      // Predictive: estimate if crossing in next 3 seconds
      if (candles.length >= 2) {
        const last = candles[candles.length-1];
        const prev = candles[candles.length-2];
        const velocity = (last.close - prev.close) / (last.epoch - prev.epoch);
        const timeToBarrier = (b - last.close) / velocity;
        if (velocity !== 0 && timeToBarrier > 0 && timeToBarrier <= 3) {
          alerts.push(`Predictive: Cross in ${timeToBarrier.toFixed(1)}s`);
        }
      }
      document.getElementById('alerts').innerHTML = alerts.join('<br>');
    }

    document.getElementById('asset').onchange = e => {
      asset = e.target.value;
      connect();
    };
    document.getElementById('timeframe').onchange = e => {
      timeframe = e.target.value;
      connect();
    };
    document.getElementById('barrier').oninput = e => {
      barrier = e.target.value;
      runSignals();
    };
    document.getElementById('zoom-in').onclick = () => chart.timeScale().zoomIn();
    document.getElementById('zoom-out').onclick = () => chart.timeScale().zoomOut();

    window.onresize = () => {
      chart.applyOptions({ width: document.getElementById('chart').offsetWidth });
    };

    // Start with initial asset/timeframe
    connect();
  </script>
</body>
</html>
